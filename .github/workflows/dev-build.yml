name: Dev Build

# Trigger on pushes to development and fix branches
on:
  push:
    branches:
      - 'dev/**'      # e.g., dev/fix-battery-polling (requires no 'dev' branch)
      - 'fix/**'      # e.g., fix/battery-timeout
      - 'feature/**'  # e.g., feature/new-device-support
      - 'test/**'     # e.g., test/workflow-verify
      - 'wip/**'      # e.g., wip/battery-polling (work in progress)
      - 'bugfix/**'   # e.g., bugfix/timeout-issue

jobs:
  dev-build:
    runs-on: windows-latest

    steps:
    # Checkout the code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Setup .NET 9
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    # Setup Python for publish.py
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # Generate version suffix with branch name and timestamp
    - name: Generate dev version
      id: version
      run: |
        $branch = "${{ github.ref_name }}" -replace '/', '-'
        $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
        $suffix = "dev-$branch-$timestamp"
        $tag = "dev-$branch-$timestamp"
        echo "suffix=$suffix" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "branch_name=$branch" >> $env:GITHUB_OUTPUT
        echo "timestamp=$timestamp" >> $env:GITHUB_OUTPUT
        Write-Host "Version suffix: $suffix"
        Write-Host "Release tag: $tag"
      shell: pwsh

    # Build and publish packages
    - name: Build dev packages
      run: python publish.py --version-suffix="-${{ steps.version.outputs.suffix }}"

    # Create draft release with build artifacts
    - name: Create draft release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "Dev Build - ${{ steps.version.outputs.branch_name }} (${{ steps.version.outputs.timestamp }})"
        draft: true
        prerelease: true
        generate_release_notes: false
        body: |
          ## Dev Build - Testing Only

          **Branch:** `${{ github.ref_name }}`
          **Commit:** ${{ github.sha }}
          **Build Time:** ${{ steps.version.outputs.timestamp }}

          ### Downloads
          - **Standalone**: Includes .NET 9 runtime (larger, no dependencies)
          - **Framedep**: Requires .NET 9 runtime pre-installed (smaller)

          ### Notes
          - This release will be deleted after testing is complete

          ---

          **Share link:** `https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}`
        files: |
          ./bin/Release/publish/Release_v*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Print release URL
    - name: Print release info
      run: |
        Write-Host "âœ… Dev build created successfully!"
        Write-Host ""
        Write-Host "ðŸ“¦ Draft Release URL:"
        Write-Host "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        Write-Host ""
        Write-Host "Share this URL with your testers!"
      shell: pwsh
